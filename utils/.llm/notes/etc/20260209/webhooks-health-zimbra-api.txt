==============================================
WEBHOOKS, HEALTH CHECK & ZIMBRA API INTEGRATION
Date: 2026-02-09
==============================================

## OVERVIEW

Implemented three priority features:
1. **Webhooks** - Real-time event delivery from Zimbra and Outlook
2. **Health Check API** - Integration connectivity verification
3. **Zimbra REST API** - Real email/calendar data fetching

---

## 1. WEBHOOKS IMPLEMENTATION

### Architecture

- **WebhooksController**: HTTP endpoints for Zimbra and Outlook webhooks
- **WebhooksService**: Event processing and notification creation
- Signature verification for security (HMAC-SHA256)
- Automatic deduplication via externalId

### Endpoints

**POST /webhooks/zimbra?userId=xxx**
- Accepts Zimbra webhook payloads
- Verifies x-zimbra-signature header
- Processes: mail.new, calendar.event, calendar.reminder, task.assigned

**GET/POST /webhooks/outlook**
- GET: Microsoft Graph subscription validation
- POST: Change notifications from MS Graph
- Verifies x-ms-client-state header
- Processes: created, updated, deleted events

### Event Types Handled

**Zimbra Events:**
- mail.new → NEW_EMAIL notification
- calendar.event → CALENDAR_EVENT notification
- calendar.reminder → UPCOMING_CALL notification
- task.assigned → TASK_ASSIGNED notification

**Outlook Events (MS Graph):**
- created → Detect resource type and route
- updated → Log update (optional notification)
- deleted → Log deletion (optional tracking)

### Security

- HMAC signature verification via crypto-js
- Environment variables:
  - ZIMBRA_WEBHOOK_SECRET
  - OUTLOOK_WEBHOOK_CLIENT_STATE
- Rejects requests with invalid signatures

### Configuration

Environment Variables:
```
ZIMBRA_WEBHOOK_SECRET=your_webhook_secret_here
OUTLOOK_WEBHOOK_CLIENT_STATE=your_client_state_here
```

---

## 2. HEALTH CHECK API

### Endpoint

**GET /integrations/{name}/health**

Returns comprehensive health status for each integration.

### Response Schema

```json
{
  "integration": "zimbra",
  "status": "healthy" | "degraded" | "unhealthy",
  "configured": true,
  "connected": true,
  "details": {
    "configValid": true,
    "apiReachable": true,
    "authValid": true,
    "lastCheck": "2026-02-09T12:00:00Z",
    "errors": [],
    "warnings": [],
    "info": {
      "smtp": {
        "host": "mail.example.com",
        "port": 587,
        "secure": false
      }
    }
  }
}
```

### Health Status Logic

- **healthy**: Configured, connected, no warnings
- **degraded**: Configured, connected, has warnings
- **unhealthy**: Not configured OR has errors OR not connected

### Checks Performed

1. Configuration validation (isConfigured())
2. Connection test (testConnection())
3. Authentication validity (implicit in connection test)
4. SMTP profile retrieval (if available)

### Implementation

Added to IntegrationsService:
- checkHealth() method
- Calls adapter methods dynamically
- Aggregates errors, warnings, and info
- Returns structured health report

---

## 3. ZIMBRA REST API INTEGRATION

### Architecture

Replaced mock data with real Zimbra SOAP API calls:
- Authenticate via AuthRequest
- Fetch emails via SearchRequest
- Fetch calendar events via SearchRequest (appointments)
- Session-based auth token caching

### Dependencies

- **axios**: HTTP client for API calls
- **AxiosInstance**: Configured with 10s timeout

### Authentication Flow

1. POST /service/soap/AuthRequest
2. Receive authToken in response
3. Include in Cookie header (ZM_AUTH_TOKEN)
4. Cache token in memory (session-scoped)

### API Methods

**authenticate()**
- Authenticates with Zimbra using username/password
- Caches authToken for subsequent requests
- Throws error if credentials missing or invalid

**testConnection()**
- Calls authenticate() + getAccountInfo()
- Returns true if successful, false otherwise
- Logs connection status

**getUnreadEmails(since?: Date)**
- Real API: POST /service/soap/SearchRequest
- Query: `is:unread after:YYYY/MM/DD` (if since provided)
- Parses message objects from SearchResponse
- Returns array of: id, subject, from, receivedAt, link

**getUpcomingCalls(withinMinutes = 60)**
- Real API: POST /service/soap/SearchRequest
- Type: appointment
- Time range: now → now + withinMinutes
- Returns array of: id, title, startAt, endAt, organizer, link

### Fallback to Mock Data

If `config.mockNotifications === true`:
- Uses predefined mockEmails and mockCalls
- Useful for demo/testing without real Zimbra server

### Zimbra SOAP Request Format

Example SearchRequest for emails:
```json
{
  "Body": {
    "SearchRequest": {
      "_jsns": "urn:zimbraMail",
      "query": "is:unread",
      "types": "message",
      "limit": 100,
      "offset": 0
    }
  }
}
```

Example SearchRequest for appointments:
```json
{
  "Body": {
    "SearchRequest": {
      "_jsns": "urn:zimbraMail",
      "calExpandInstStart": 1733800000000,
      "calExpandInstEnd": 1733803600000,
      "types": "appointment",
      "limit": 50
    }
  }
}
```

### Configuration Required

```
ZIMBRA_BASE_URL=https://mail.example.com
ZIMBRA_USERNAME=user@example.com
ZIMBRA_PASSWORD=your_password_here
```

---

## FILES CREATED

1. apps/api/src/modules/webhooks/webhooks.service.ts
   - Event processing logic
   - Signature verification
   - Notification creation

2. apps/api/src/modules/webhooks/webhooks.controller.ts
   - Webhook HTTP endpoints
   - Zimbra and Outlook routes
   - Validation handlers

3. apps/api/src/modules/webhooks/webhooks.module.ts
   - Module wiring
   - Imports NotificationsModule

## FILES MODIFIED

1. apps/api/src/app.module.ts
   - Added WebhooksModule import and registration

2. apps/api/src/modules/integrations/integrations.controller.ts
   - Added GET /:id/health endpoint

3. apps/api/src/modules/integrations/integrations.service.ts
   - Added checkHealth() method
   - Dynamic adapter capability detection

4. apps/api/src/modules/integrations/adapters/zimbra.adapter.ts
   - Added axios HTTP client
   - Implemented authenticate()
   - Implemented getAccountInfo()
   - Real API calls in getUnreadEmails()
   - Real API calls in getUpcomingCalls()
   - Helper methods: formatZimbraDate(), extractEmail()

## NPM PACKAGES INSTALLED

- axios
- @types/axios
- crypto-js
- @types/crypto-js

---

## TESTING WEBHOOKS

### Test Zimbra Webhook

```bash
curl -X POST http://localhost:3000/webhooks/zimbra?userId=user123 \
  -H "Content-Type: application/json" \
  -H "x-zimbra-signature: YOUR_SIGNATURE" \
  -d '{
    "eventType": "mail.new",
    "data": {
      "id": "12345",
      "from": "sender@example.com",
      "subject": "Test Email",
      "hasAttachments": false,
      "webLink": "https://mail.example.com/modern/email/12345"
    },
    "timestamp": "2026-02-09T12:00:00Z"
  }'
```

### Test Outlook Webhook (Validation)

```bash
curl "http://localhost:3000/webhooks/outlook?validationToken=abc123"
# Should return: abc123
```

### Test Outlook Webhook (Event)

```bash
curl -X POST http://localhost:3000/webhooks/outlook \
  -H "Content-Type: application/json" \
  -H "x-ms-client-state: YOUR_CLIENT_STATE" \
  -d '{
    "value": [{
      "subscriptionId": "sub-123",
      "clientState": "YOUR_CLIENT_STATE",
      "changeType": "created",
      "resource": "users/abc-123-def/messages/msg-456",
      "resourceData": {
        "@odata.type": "#microsoft.graph.message",
        "id": "msg-456",
        "subject": "Test Message",
        "from": {
          "emailAddress": {
            "address": "sender@example.com"
          }
        }
      }
    }]
  }'
```

---

## TESTING HEALTH CHECK

```bash
# Check Zimbra health
curl http://localhost:3000/integrations/zimbra/health | jq

# Check Outlook health
curl http://localhost:3000/integrations/outlook/health | jq

# Check all integrations
for integration in zimbra outlook nextcloud whatsapp; do
  echo "=== $integration ==="
  curl -s http://localhost:3000/integrations/$integration/health | jq '.status'
done
```

Expected response:
```json
{
  "integration": "zimbra",
  "status": "healthy",
  "configured": true,
  "connected": true,
  "details": {
    "configValid": true,
    "apiReachable": true,
    "authValid": true,
    "lastCheck": "2026-02-09T12:00:00.000Z",
    "info": {
      "connectionTest": "passed",
      "smtp": {
        "host": "mail.example.com",
        "port": 587,
        "secure": false
      }
    }
  }
}
```

---

## NEXT STEPS

1. **Outlook Real API**: Implement MS Graph API calls similar to Zimbra
2. **Webhook Subscriptions**: Create endpoints to register webhook subscriptions
3. **Rate Limiting**: Add rate limiting to webhook endpoints
4. **Retry Logic**: Implement retry for failed API calls
5. **Frontend Integration**: Build notification UI components
6. **Email Routing**: Add configuration for profile-based routing

---

## NOTES

- Webhooks require external systems to be configured to POST events
- Health check requires proper credentials in environment variables
- Zimbra API uses SOAP format (not REST), wrapped in JSON
- Mock data still available via config.mockNotifications flag
- Auth tokens cached in memory (consider Redis for production)
- Signature verification optional but strongly recommended
