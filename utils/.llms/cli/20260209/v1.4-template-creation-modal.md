# v1.4 - Template Creation Modal with Form Validation & Backend Security

## Overview

Version 1.4 adds a comprehensive template creation feature with strict frontend validation and backend security hardening.

## Key Features

### 1. Template Creation Modal (`TemplateCreationModal.vue`)

A Vue 3 Composition API component with comprehensive form validation:

#### HTML5 Validation Attributes

```vue
<input
  type="text"
  name="key"
  required
  :minlength="3"
  :maxlength="64"
  :pattern="'^[a-zA-Z][a-zA-Z0-9_-]*$'"
  aria-required="true"
  :aria-invalid="hasFieldError('key')"
  :aria-describedby="hasFieldError('key') ? 'key-error' : 'key-help'"
/>
```

#### Data Attributes for Form State (DOMStringMap)

```vue
<form
  :data-form-id="formSessionId"
  :data-form-state="formBlocked ? 'blocked' : isFormValid ? 'valid' : 'invalid'"
  :data-form-touched="touchedFields.size > 0"
  :data-validation-mode="'strict'"
>
```

#### Fieldset Blocking on Invalid Data

```typescript
const blockForm = () => {
  formBlocked.value = true;
  if (fieldsetRef.value) {
    fieldsetRef.value.disabled = true;
  }
  // Re-enable after delay for user to see errors
  setTimeout(() => unblockForm(), 1500);
};
```

### 2. Backend Validation (Zod + DOMPurify)

#### Zod Schema (`template.schema.ts`)

```typescript
export const CreateTemplateSchema = z
  .object({
    key: z
      .string()
      .trim()
      .min(3, "Chave deve ter no mínimo 3 caracteres")
      .max(64, "Chave deve ter no máximo 64 caracteres")
      .regex(/^[a-zA-Z][a-zA-Z0-9_-]*$/, "Formato inválido"),
    name: z.string().trim().min(2).max(128),
    content: z.string().max(65536),
    category: z.enum(["email", "project", "task", "notification", "report"]),
    // ...
  })
  .strict();
```

#### Sanitizer Service (`sanitizer.service.ts`)

```typescript
// SQL Injection Detection
const SQL_INJECTION_PATTERNS = [
  /(\b(SELECT|INSERT|UPDATE|DELETE|DROP|CREATE)\b)/i,
  /('|"|;|--|\bOR\b|\bAND\b)\s*(\d+=\d+|\w+=\w+)/i,
  // ...
];

// XSS Protection via DOMPurify
sanitizeHtml(html: string): string {
  return DOMPurify.sanitize(html, DOMPURIFY_CONFIG);
}
```

#### Validation Pipe (`zod-validation.pipe.ts`)

```typescript
@Injectable()
export class ZodValidationPipe<T> implements PipeTransform<unknown, T> {
  transform(value: unknown, metadata: ArgumentMetadata): T {
    // Pre-sanitization security scan
    this.scanObjectForThreats(value as Record<string, unknown>);

    // Sanitize if enabled
    sanitizedValue = this.sanitizer.sanitizeObject(
      value,
      this.options.allowHtml,
    );

    // Validate with Zod schema
    return this.schema.parse(sanitizedValue);
  }
}
```

### 3. Updated Templates Controller

Before (insecure):

```typescript
@Post()
async create(@Body() dto: any) {  // ❌ Untyped
  return this.svc.create(dto);
}
```

After (secure):

```typescript
@Post()
async create(
  @Body(new ZodValidationPipe(CreateTemplateSchema, {
    sanitize: true,
    allowHtml: true,
    blockSqlInjection: true,
  }))
  dto: CreateTemplateDto,  // ✅ Typed & Validated
) {
  // Additional sanitization for HTML content
  const sanitizedDto = {
    ...dto,
    content: this.sanitizer.sanitizeHtml(dto.content),
    name: this.sanitizer.sanitizeText(dto.name),
  };
  return this.svc.create(sanitizedDto);
}
```

## File Changes

### New Files Created

| File                                                       | Purpose                             |
| ---------------------------------------------------------- | ----------------------------------- |
| `apps/api/src/common/validation/template.schema.ts`        | Zod schemas for template DTOs       |
| `apps/api/src/common/validation/sanitizer.service.ts`      | DOMPurify + SQL injection detection |
| `apps/api/src/common/validation/zod-validation.pipe.ts`    | NestJS validation pipe              |
| `apps/api/src/common/validation/index.ts`                  | Barrel exports                      |
| `apps/api/src/common/validation/template.schema.spec.ts`   | Unit tests for schemas              |
| `apps/api/src/common/validation/sanitizer.service.spec.ts` | Unit tests for sanitizer            |
| `apps/web/src/components/modal/TemplateCreationModal.vue`  | Frontend modal component            |

### Modified Files

| File                                                     | Changes                                           |
| -------------------------------------------------------- | ------------------------------------------------- |
| `apps/api/package.json`                                  | Added `isomorphic-dompurify`, Jest config         |
| `apps/api/src/entities/ProjectTemplateEntity.ts`         | Added content, subject, isActive, metadata fields |
| `apps/api/src/modules/templates/templates.controller.ts` | Added Zod validation, sanitization                |
| `apps/api/src/modules/templates/templates.service.ts`    | Typed DTOs, new methods                           |
| `apps/web/src/components/client/ClientDetailView.vue`    | Modal integration                                 |

## Validation Constants

```typescript
export const TEMPLATE_VALIDATION = {
  KEY: { MIN_LENGTH: 3, MAX_LENGTH: 64 },
  NAME: { MIN_LENGTH: 2, MAX_LENGTH: 128 },
  DESCRIPTION: { MAX_LENGTH: 512 },
  CONTENT: { MAX_LENGTH: 65536 },
  SUBJECT: { MAX_LENGTH: 256 },
  CATEGORY: { VALUES: ["email", "project", "task", "notification", "report"] },
};
```

## Security Features

1. **Frontend Validation**
   - HTML5 validation attributes (required, minlength, maxlength, pattern)
   - Real-time validation feedback
   - Form blocking on invalid submission
   - ARIA attributes for accessibility

2. **Backend Validation**
   - Zod schema type safety
   - SQL injection pattern detection
   - XSS protection via DOMPurify
   - Input sanitization (strip/escape dangerous content)

3. **Data Attributes for Tracking**
   - `data-form-state`: 'valid' | 'invalid' | 'blocked'
   - `data-field-touched`: boolean
   - `data-field-valid`: boolean
   - `data-validation-mode`: 'strict'

## Test Results

```
Template Validation Schemas
  ✓ 39 tests passing

SanitizerService
  ✓ 53 tests passing
```

## Usage Example

```vue
<TemplateCreationModal
  :is-open="showModal"
  :client-id="client.id"
  :client-name="client.name"
  @close="closeModal"
  @submit="handleSubmit"
/>
```

## Dependencies Added

```json
{
  "dependencies": {
    "isomorphic-dompurify": "^2.x.x"
  },
  "devDependencies": {
    "@types/dompurify": "^3.x.x"
  }
}
```

## Security Audit Note

Found 19 controllers with `@Body() dto: any` patterns that should be migrated to typed Zod validation:

- `projects.controller.ts` (2)
- `tasks.controller.ts` (2)
- `notes.controller.ts` (2)
- `tags.controller.ts` (1)
- `comments.controller.ts` (2)
- `milestones.controller.ts` (2)
- `clients.controller.ts` (2)
- `leads.controller.ts` (5)

These represent technical debt that should be addressed in future versions using the same pattern implemented for templates.
